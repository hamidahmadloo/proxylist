<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¯Ù†ÛŒØ§ÛŒ Ø¨Ø¯ÙˆÙ† Ù…Ø±Ø² ØªÙ„Ú¯Ø±Ø§Ù… | Ù¾Ø±ÙˆÚ©Ø³ÛŒâ€ŒÛŒØ§Ø¨</title>

<!-- Font Awesome Free (Ø¨Ø±Ø§ÛŒ Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" />

<!-- IRANSans CDN ÛŒØ§ Ù…Ø­Ù„ÛŒ -->
<style>
@import url('https://cdn.jsdelivr.net/gh/rastikerdar/IRANSans@6.2.0/dist/font-face.css');
body, button, input { font-family: 'IRANSans', sans-serif; }
</style>

<style>
:root {
  --c1: #B1B2FF; --c2: #AAC4FF; --c3: #D2DAFF; --c4: #EEF1FF;
  --text: #0f172a; --muted: #475569;
  --btn-connect: #4f46e5; --btn-copy: #059669; --btn-qr: #0ea5e9;
  --shadow: 0 10px 30px rgba(2,6,23,.12);
}
:root.theme-dark {
  --c1: #404258; --c2: #474E68; --c3: #50577A; --c4: #6B728E;
  --text: #f8fafc; --muted: #cbd5e1;
  --btn-connect: #818cf8; --btn-copy: #34d399; --btn-qr: #38bdf8;
  --shadow: 0 10px 30px rgba(15,23,42,.35);
}
body { margin:0; background: var(--c4); color: var(--text); }
.container { max-width:1200px;margin:0 auto;padding:16px; }
.header { display:flex; align-items:center; gap:12px; padding:12px; background:var(--c3); border-radius:12px; margin-bottom:12px; }
.header .logo { width:36px; height:36px; border-radius:8px; background:#0088cc; display:grid; place-items:center; color:white; }
.header .brand { font-weight:700; font-size:20px; display:flex; align-items:center; gap:8px; }
.header .controls { margin-left:auto; display:flex; gap:8px; }
.btn { padding:8px 12px; border:none; border-radius:12px; cursor:pointer; color:white; display:flex; align-items:center; gap:6px; font-family:IRANSans; }
.btn-connect { background: var(--btn-connect); } .btn-copy { background: var(--btn-copy); } .btn-qr { background: var(--btn-qr); }
.grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); }
.card { background: var(--c3); border-radius:16px; padding:16px; box-shadow:var(--shadow); display:grid; gap:8px; }
.card-header { display:flex; gap:8px; align-items:center; }
.badge { padding:4px 8px; border-radius:12px; background:var(--c2); font-size:12px; }
.meta { font-size:14px; color:var(--muted); }
.kvs { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); place-items:center; }
.modal.show { display:grid; }
.modal-card { background: var(--c4); color: var(--text); border-radius:16px; padding:16px; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.qr-box { display:grid; place-items:center; padding:16px; border:1px dashed var(--c2); border-radius:12px; background: var(--c3); }
.footer { text-align:center; margin-top:20px; color:var(--muted); }
.footer a { color:var(--btn-qr); text-decoration:none; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<header class="header">
  <div class="logo"><i class="fab fa-telegram-plane"></i></div>
  <div class="brand">Ø¯Ù†ÛŒØ§ÛŒ Ø¨Ø¯ÙˆÙ† Ù…Ø±Ø² ØªÙ„Ú¯Ø±Ø§Ù…</div>
  <div class="controls">
    <button id="themeToggle" class="btn"><i class="fa-solid fa-moon"></i> Ø­Ø§Ù„Øª Ø´Ø¨/Ø±ÙˆØ²</button>
    <button id="refreshBtn" class="btn"><i class="fa-solid fa-arrows-rotate"></i> Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
  </div>
</header>

<main class="container">
  <h3>MTPROTO</h3>
  <section id="mtprotoGrid" class="grid"></section>
  <h3>SOCKS5</h3>
  <section id="socksGrid" class="grid"></section>
</main>

<div class="modal" id="qrModal">
  <div class="modal-card">
    <div class="modal-header">
      <strong>Ú©ÛŒÙˆØ¢Ø± Ø§ØªØµØ§Ù„</strong>
      <button id="qrClose" class="btn"><i class="fa-solid fa-xmark"></i> Ø¨Ø³ØªÙ†</button>
    </div>
    <div class="qr-box" id="qrBox"></div>
  </div>
</div>

<footer class="footer">
  Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ <a href="https://t.me/hamid_ahmadloo" target="_blank"><i class="fab fa-telegram"></i> @Hamid_Ahmadloo</a>
</footer>

<script>
const API_BASE = 'http://localhost:3000/proxy';

const mtGrid = document.getElementById('mtprotoGrid');
const skGrid = document.getElementById('socksGrid');

async function fetchJSON(type){
  const res = await fetch(`${API_BASE}?type=${type}`);
  if(!res.ok) throw new Error(res.statusText);
  return res.json();
}

function countryFlag(code){
  if(!code || code.length!==2) return 'ğŸ³ï¸';
  const A = 0x1F1E6;
  const cc = code.toUpperCase();
  return String.fromCodePoint(A + cc.charCodeAt(0), A + cc.charCodeAt(1));
}

function timeAgo(unix){
  if(!unix) return 'â€”';
  const secs = Math.max(0, Math.floor(Date.now()/1000) - Number(unix));
  if(secs>86400) return `${Math.floor(secs/86400)} Ø±ÙˆØ² Ù¾ÛŒØ´`;
  if(secs>3600) return `${Math.floor(secs/3600)} Ø³Ø§Ø¹Øª Ù¾ÛŒØ´`;
  if(secs>60) return `${Math.floor(secs/60)} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´`;
  return 'Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ Ù¾ÛŒØ´';
}

function buildCard(item, type){
  const title = type==='mtproto'? item.host: item.ip;
  const port = item.port;
  const country = item.country || 'â€”';
  const provider = item.provider || 'â€”';
  const ping = item.ping ?? 'â€”';
  const addTime = timeAgo(item.addTime);
  const updateTime = timeAgo(item.updateTime);
  const uptime = item.uptime ?? 'â€”';
  const link = type==='mtproto' 
    ? `tg://proxy?server=${item.host}&port=${port}&secret=${item.secret}` 
    : `tg://socks?server=${item.ip}&port=${port}`;
  const copyText = type==='mtproto'
    ? `mtproto://${item.host}:${port}?secret=${item.secret}`
    : `socks5://${item.ip}:${port}`;
  
  const card = document.createElement('article');
  card.className='card';
  card.innerHTML=`
    <div class="card-header">
      <span class="badge">${type.toUpperCase()}</span>
      <strong>${title}</strong>:${port}
    </div>
    <div class="meta">
      Ú©Ø´ÙˆØ±: ${country} ${countryFlag(country)} | Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡: ${provider} | Ù¾ÛŒÙ†Ú¯: ${ping}ms
    </div>
    <div class="meta">
      Ø§ÙØ²ÙˆØ¯Ù†: ${addTime} ${type==='mtproto'? '| Ø¢Ù¾â€ŒØªØ§ÛŒÙ…: '+uptime+'% | Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: '+updateTime : ''}
    </div>
    <div class="meta">
      <button class="btn btn-connect" onclick="window.open('${link}','_blank')"><i class="fa-solid fa-plug"></i> Ø§ØªØµØ§Ù„</button>
      <button class="btn btn-copy" data-copy="${copyText}"><i class="fa-solid fa-copy"></i> Ú©Ù¾ÛŒ</button>
      <button class="btn btn-qr" data-qr="${link}"><i class="fa-solid fa-qrcode"></i> Ú©ÛŒÙˆØ¢Ø±</button>
    </div>
  `;
  
  // Copy
  card.querySelector('.btn-copy').addEventListener('click', async e=>{
    try{
      await navigator.clipboard.writeText(e.currentTarget.dataset.copy);
      e.currentTarget.innerText='Ú©Ù¾ÛŒ Ø´Ø¯';
      setTimeout(()=>{ e.currentTarget.innerHTML=`<i class="fa-solid fa-copy"></i> Ú©Ù¾ÛŒ`; },1500);
    }catch{ alert('Ú©Ù¾ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚'); }
  });

  // QR
  card.querySelector('.btn-qr').addEventListener('click', e=>{
    openQR(e.currentTarget.dataset.qr);
  });

  return card;
}

const qrModal = document.getElementById('qrModal');
const qrBox = document.getElementById('qrBox');
document.getElementById('qrClose').addEventListener('click',()=>{ qrModal.classList.remove('show'); qrBox.innerHTML=''; });

function openQR(text){
  qrModal.classList.add('show'); qrBox.innerHTML=''; new QRCode(qrBox,{text,width:240,height:240});
}

// Theme toggle
const themeToggle = document.getElementById('themeToggle');
themeToggle.addEventListener('click',()=>{
  document.documentElement.classList.toggle('theme-dark');
});

// Refresh
document.getElementById('refreshBtn').addEventListener('click', init);

async function init(){
  try{
    const [mt, sk] = await Promise.all([fetchJSON('mtproto'), fetchJSON('socks')]);
    mtGrid.innerHTML=''; skGrid.innerHTML='';
    mt.forEach(item=> mtGrid.appendChild(buildCard(item,'mtproto')));
    sk.forEach(item=> skGrid.appendChild(buildCard(item,'socks')));
  }catch(err){
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª: '+err.message);
  }
}

init();
</script>
</body>
</html>
